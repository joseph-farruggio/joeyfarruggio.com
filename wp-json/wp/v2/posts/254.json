{"id":254,"date":"2019-12-30T16:29:00","date_gmt":"2019-12-30T16:29:00","guid":{"rendered":"http:\/\/joeyfarruggio.com\/?p=254"},"modified":"2020-01-24T20:50:34","modified_gmt":"2020-01-24T20:50:34","slug":"custom-post-loop-as-a-gutenberg-block","status":"publish","type":"post","link":"https:\/\/joeyfarruggio.com\/wordpress\/custom-post-loop-as-a-gutenberg-block\/","title":{"rendered":"6-Step Guide To Custom Post Loop Gutenberg Blocks"},"content":{"rendered":"\n<p>Here&#8217;s what we&#8217;ll accomplish in this brief guide &#8211; we&#8217;ll have a custom Gutenberg block that allows you to interface with the <code>WP_Query<\/code> class. You can loop through your posts or a custom post type and add query parameters like taxonomy, post count, and post order.<\/p>\n\n\n\n<p>To demonstrate this, we&#8217;ll create a Testimonials block. The block will query a testimonial custom post type and display posts in a template.<\/p>\n\n\n\n<p>In my previous post I covered how to create a custom <a href=\"\/wordpress\/custom-gutenberg-block-advanced-custom-fields\/\">Gutenberg block<\/a> with Advanced Custom Field&#8217;s <code>acf_register_block_type()<\/code>. But the <a href=\"https:\/\/www.advancedcustomfields.com\/resources\/acf_register_block_type\/\">ACF documentation<\/a> is a more complete resource.<\/p>\n\n\n\n<h2 id=\"set-up-cpt\">Setting up the CPT<\/h2>\n\n\n\n<p>I recommend using the free&nbsp;<a href=\"https:\/\/wordpress.org\/plugins\/custom-post-type-ui\/\">CPT UI<\/a>&nbsp;plugin for quickly setting up custom post types.<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"1024\" height=\"827\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/acf-custom-post-type.png\" alt=\"\" class=\"wp-image-467\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/acf-custom-post-type.png 1024w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/acf-custom-post-type-300x242.png 300w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/acf-custom-post-type-768x620.png 768w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<p>I don&#8217;t want to use Gutenberg to create the testimonial itself. The classic editor or custom fields will do just fine. In order to disable Gutenberg for the CPT you need to set the <code>Show in REST API<\/code> to false. Set it to true if you do want to use the Gutenberg editor.<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"1024\" height=\"122\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/show-in-rest.png\" alt=\"\" class=\"wp-image-468\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/show-in-rest.png 1024w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/show-in-rest-300x36.png 300w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/show-in-rest-768x92.png 768w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<h2 id=\"create-custom-fields\">Creating the Custom Fields<\/h2>\n\n\n\n<p>Within Advanced Custom Fields, I created just one field for the testimonial author&#8217;s company name. I&#8217;ll use the post title for the author&#8217;s name, the feature image for the author&#8217;s profile image, and the default classic editor for the testimonial content itself.<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"1024\" height=\"465\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/testimonial-field-group-1024x465.png\" alt=\"\" class=\"wp-image-469\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/testimonial-field-group-1024x465.png 1024w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/testimonial-field-group-300x136.png 300w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/testimonial-field-group-768x348.png 768w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/testimonial-field-group-1536x697.png 1536w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/testimonial-field-group.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<h2 id=\"register-testimonial-block\">Register the Block<\/h2>\n\n\n\n<p>Within your <code>functions.php<\/code> file register your testimonial block. Be sure to scan through the <a href=\"https:\/\/www.advancedcustomfields.com\/resources\/acf_register_block_type\/\">ACF documentation<\/a> to fully understand what&#8217;s happening here, but most of it should be self explanatory.<\/p>\n\n\n\n<pre title=\"functions.php\" class=\"wp-block-code\"><code lang=\"php\" class=\"language-php line-numbers\">\/\/ Register Custom Blocks\nadd_action('acf\/init', 'my_register_blocks');\nfunction my_register_blocks() {\n\n    \/\/ check function exists.\n    if( function_exists('acf_register_block_type') ) {\n\n        \/\/ register a testimonial block.\n        acf_register_block_type(array(\n            'name'\t\t\t\t=> 'testimonials',\n            'title'\t\t\t\t=> __( 'Testimonials'),\n            'description'\t\t=> __( 'A custom testimonial block.'),\n            'render_template'   => 'template-parts\/blocks\/testimonials\/block.php',\n            'category'\t\t\t=> 'formatting',\n            'icon'\t\t\t\t=> 'admin-comments',\n            'keywords'\t\t\t=> array( 'testimonial' ),\n            'enqueue_style' => get_template_directory_uri() . '\/template-parts\/blocks\/testimonial\/testimonial.css',\n        ));\n    }\n}<\/code><\/pre>\n\n\n\n<p><strong>A note on enqueuing block CSS and JS:<\/strong><\/p>\n\n\n\n<p>When you enqueue your CSS and JS within the <code>acf_register_block_type()<\/code> function, your assets are only loaded when your block is present on a page. And those assets get enqueued both on the front-end and the back-end. If you view your block from the editor with preview mode, you may notice areas where you&#8217;ll need to write extra CSS scoped specifically for preview mode in the editor. This is because the Gutenberg editor itself enqueues default styling that may affect your block in an unintended way.<\/p>\n\n\n\n<p>The <code>enqueue_style<\/code> above reflects the ACF documentation in that the CSS is being enqueued from the same directory as the block template itself.<\/p>\n\n\n\n<p>This isn&#8217;t how I do it in my themes though. I have all of my theme and block SCSS in a <code>\/src<\/code> directory and that SCSS gets compiled to CSS and minified in a <code>\/dist<\/code> directory. SCSS files for blocks live in <code>\/src\/scss\/blocks\/block_name.scss<\/code>. That means I&#8217;ll enqueue my block CSS like so:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"php\" class=\"language-php\">'enqueue_style' => get_template_directory_uri() . '\/dist\/css\/blocks\/block_name.min.css'<\/code><\/pre>\n\n\n\n<h2 id=\"create-block-fields\">Create the Block Fields<\/h2>\n\n\n\n<p>I want some level of configuration over my testimonial block. Depending on where I use it, I&#8217;ll want to either loop testimonials with a <code>posts_per_page<\/code> to set a limit or I&#8217;ll want to hand select which testimonials to display.<\/p>\n\n\n\n<p>Back in Advanced Custom Fields we&#8217;ll create three fields to create this functionality.<\/p>\n\n\n\n<p>Note: I like prefixing my ACF field groups that contain block controls with &#8220;<strong><em>Block:<\/em><\/strong>&#8220;. This way I can more easily distinguish field groups that are used for the Testimonial CPT and field groups for the block that displays testimonials.<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"1024\" height=\"569\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-testimonials-1024x569.png\" alt=\"\" class=\"wp-image-470\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-testimonials-1024x569.png 1024w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-testimonials-300x167.png 300w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-testimonials-768x427.png 768w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-testimonials-1536x854.png 1536w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-testimonials.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<p>In this field group I&#8217;ve created a Button Group to allow the user to select between limiting the post loop with a post count or selecting from a list of published testimonials.<\/p>\n\n\n\n<p>The <code>Loop Argument Type<\/code> field contains two options:<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"json\" class=\"language-json\">count : Count\nselect : Select Posts<\/code><\/pre>\n\n\n\n<p>Both the <code>Testimonial Count<\/code> and <code>Select Testimonials<\/code> fields have a conditional setting to only be displayed based  on the selection of <code>Loop Argument Type<\/code>.<\/p>\n\n\n\n<p>The <code>Select Testimonials<\/code> field should be set to return just the post ID.<\/p>\n\n\n\n<h2 id=\"build-template\">Building the Block Template<\/h2>\n\n\n\n<p>Next I&#8217;ll create my template and add some PHP to handle any logic needed for the loop.<\/p>\n\n\n\n<pre title=\"template-parts\/blocks\/testimonials\/block.php\" class=\"wp-block-code\"><code lang=\"php\" class=\"language-php line-numbers\">&lt;?php\n\/**\n * Block Name: Testimonials\n *\n * This is the template that displays the testimonials loop block.\n *\/\n\n$argType = get_field( 'loop_argument_type' );\nif( $argType == \"count\" ) :\n  $args = array( \n    'orderby' => 'title',\n    'post_type' => 'testimonials',\n    'posts_per_page' => get_field( 'testimonial_count' )\n  );\nelse:\n  $testimonials = get_field( 'select_testimonials' );\n  $args = array( \n    'orderby' => 'title',\n    'post_type' => 'testimonials',\n    'post__in' => $testimonials\n  );\nendif;\n\n$the_query = new WP_Query( $args );<\/code><\/pre>\n\n\n\n<p>Then, I&#8217;ll start the loop and populate our testimonial fields in the same template. Now, the markup and CSS is up to you. I&#8217;m keeping it simple for this guide.<\/p>\n\n\n\n<pre title=\"template-parts\/blocks\/testimonials\/block.php\" class=\"wp-block-code\"><code lang=\"php\" class=\"language-php line-numbers\">continued code...\n\n&lt;?php \n  if ( $the_query->have_posts() ) :\n    while ( $the_query->have_posts() ) : $the_query->the_post(); ?>\n      \n      &lt;div class=\"testimonial\">\n        &lt;?php the_post_thumbnail('post-thumbnail'); ?>\n        &lt;?php the_content(); ?>\n        &lt;b>&lt;?php the_title(); ?>&lt;\/b> &lt;br>\n        &lt;small>&lt;?php the_field('company', get_the_ID()); ?>&lt;\/small>\n      &lt;\/div>\n    \n    &lt;?php endwhile; ?>\n&lt;?php endif;?><\/code><\/pre>\n\n\n\n<p><strong>IMPORTANT<\/strong><\/p>\n\n\n\n<p>There&#8217;s one thing that I need to point out here to save you from some frustration. When looping through posts in a Gutenberg block, you must add the post ID as the second parameter when using &#8216;get_field()&#8217;. Otherwise, get_field() is scoped to the post\/page that your block is published on and not the testimonial itself.<\/p>\n\n\n\n<pre class=\"wp-block-code\"><code lang=\"php\" class=\"language-php\">&lt;?php echo get_field( 'quote', get_the_ID() ); ?><\/code><\/pre>\n\n\n\n<h2 id=\"using-block\">Using the Testimonial Block<\/h2>\n\n\n\n<p>I want to add testimonials to my home page, so within the editor I added a testimonial block. If I want to simple display the latest X number of posts, I can do that by setting <code>Loop Argument Type<\/code> to <code>Count<\/code> and then setting a <code>Testimonial Count<\/code>:<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"1024\" height=\"346\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/loop-args-1024x346.png\" alt=\"\" class=\"wp-image-471\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/loop-args-1024x346.png 1024w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/loop-args-300x101.png 300w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/loop-args-768x259.png 768w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/loop-args.png 1226w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<p>But if I wanted to hand pick which testimonials I wanted to display, I could set the <code>Loop Argument Type<\/code> to <code>Select Posts<\/code>:<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"1024\" height=\"642\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/using-block-1024x642.png\" alt=\"\" class=\"wp-image-472\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/using-block-1024x642.png 1024w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/using-block-300x188.png 300w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/using-block-768x482.png 768w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/using-block.png 1202w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/figure>\n\n\n\n<p>And there we have it! Our custom post type is looped and applied to a custom template which is configurable and reusable as a block throughout any post or page.<\/p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img loading=\"lazy\" width=\"999\" height=\"1024\" src=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-in-use-999x1024.png\" alt=\"\" class=\"wp-image-473\" srcset=\"https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-in-use-999x1024.png 999w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-in-use-293x300.png 293w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-in-use-768x787.png 768w, https:\/\/joeyfarruggio.com\/wp-content\/uploads\/2019\/12\/block-in-use.png 1372w\" sizes=\"(max-width: 999px) 100vw, 999px\" \/><\/figure>\n","protected":false},"excerpt":{"rendered":"<p>Here&#8217;s what we&#8217;ll accomplish in this brief guide &#8211; we&#8217;ll have a custom Gutenberg block that allows you to interface with the WP_Query class. You can loop through your posts or a custom post type and add query parameters like taxonomy, post count, and post order. To demonstrate this, we&#8217;ll create a Testimonials block. The [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":363,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":[],"categories":[3],"tags":[],"_links":{"self":[{"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/posts\/254"}],"collection":[{"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/comments?post=254"}],"version-history":[{"count":10,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/posts\/254\/revisions"}],"predecessor-version":[{"id":524,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/posts\/254\/revisions\/524"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/media\/363"}],"wp:attachment":[{"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/media?parent=254"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/categories?post=254"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/joeyfarruggio.com\/wp-json\/wp\/v2\/tags?post=254"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}